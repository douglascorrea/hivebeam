FROM elixir:1.19-otp-27

ARG CODEX_ACP_GIT_REPO=https://github.com/douglascorrea/codex-acp.git
ARG CODEX_ACP_GIT_REF=5d8c939

ENV RUSTUP_HOME=/usr/local/rustup \
    CARGO_HOME=/usr/local/cargo \
    PATH=/usr/local/cargo/bin:${PATH}

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
      build-essential \
      ca-certificates \
      curl \
      git \
      libcap-dev \
      libseccomp-dev \
      libssl-dev \
      npm \
      pkg-config \
    && rm -rf /var/lib/apt/lists/* \
    && curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
      | sh -s -- -y --profile minimal --default-toolchain stable \
    && npm install -g @openai/codex \
    && cargo install --locked --git "${CODEX_ACP_GIT_REPO}" --rev "${CODEX_ACP_GIT_REF}" codex-acp \
    && useradd --create-home --shell /bin/bash node \
    && mkdir -p /home/node/.codex \
    && mkdir -p /home/node/.mix_build \
    && mkdir -p /home/node/.mix_deps \
    && mkdir -p /workspace \
    && chown -R node:node /home/node/.codex /home/node/.mix_build /home/node/.mix_deps /workspace

USER node

WORKDIR /workspace

RUN mix local.hex --force && mix local.rebar --force

CMD ["mix", "codex.bridge.run"]
