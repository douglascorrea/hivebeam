services:
  codex-node:
    build:
      context: .
      dockerfile: Dockerfile.codex
    container_name: codex-node
    user: node
    working_dir: /workspace
    environment:
      HIVEBEAM_NODE_NAME: ${HIVEBEAM_NODE_NAME:-codex@localhost}
      HIVEBEAM_COOKIE: ${HIVEBEAM_COOKIE:-hivebeam_cookie}
      HIVEBEAM_CLUSTER_NODES: ${HIVEBEAM_CLUSTER_NODES:-}
      HIVEBEAM_ERL_DIST_PORT: ${HIVEBEAM_ERL_DIST_PORT:-9100}
      HIVEBEAM_BIND_IP: ${HIVEBEAM_BIND_IP:-0.0.0.0}
      HIVEBEAM_CODEX_ACP_CMD: ${HIVEBEAM_CODEX_ACP_CMD:-/usr/local/cargo/bin/codex-acp}
      MIX_BUILD_ROOT: /home/node/.mix_build
      MIX_DEPS_PATH: /home/node/.mix_deps
      MIX_NO_INTERACTION: "1"
    volumes:
      - .:/workspace
      - codex-config:/home/node/.codex
      - codex-mix-build:/home/node/.mix_build
      - codex-mix-deps:/home/node/.mix_deps
    ports:
      - "${HIVEBEAM_BIND_IP:-0.0.0.0}:4369:4369"
      - "${HIVEBEAM_BIND_IP:-0.0.0.0}:${HIVEBEAM_ERL_DIST_PORT:-9100}:${HIVEBEAM_ERL_DIST_PORT:-9100}"
      - "1455:1455"
      - "5051:5051"
    tty: true
    stdin_open: true
    command:
      - sh
      - -lc
      - mix deps.get && mix compile && ERL_AFLAGS="-name ${HIVEBEAM_NODE_NAME:-codex@localhost} -setcookie ${HIVEBEAM_COOKIE:-hivebeam_cookie} -kernel inet_dist_listen_min ${HIVEBEAM_ERL_DIST_PORT:-9100} inet_dist_listen_max ${HIVEBEAM_ERL_DIST_PORT:-9100}" mix codex.bridge.run

volumes:
  codex-config:
  codex-mix-build:
  codex-mix-deps:
